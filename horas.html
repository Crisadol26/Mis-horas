<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Overtime Pro - Cloud</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; }
        .glass-card { background: white; border: 1px solid #e2e8f0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-bounce-slow { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(0); } }
    </style>
</head>
<body class="pb-24">

    <div id="root"></div>

    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, setDoc, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // NOTA: Estos valores se inyectan autom√°ticamente en este entorno. 
        // Si lo subes a tu propio servidor, aseg√∫rate de colocar tus credenciales de Firebase aqu√≠.
        const firebaseConfig = {
            apiKey: "", // El entorno lo provee autom√°ticamente
            authDomain: "project-id.firebaseapp.com",
            projectId: "project-id",
            storageBucket: "project-id.appspot.com",
            messagingSenderId: "123456",
            appId: "1:123456:web:123456"
        };

        // Para esta demo usaremos las variables globales del sistema
        const config = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = window.__app_id || 'overtime-pro-app';

        window.FB_SERVICES = { auth, db, appId, signInAnonymously, onAuthStateChanged, collection, addDoc, onSnapshot, deleteDoc, doc, setDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [entries, setEntries] = useState([]);
            const [viewingDate, setViewingDate] = useState(new Date());
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState({ show: false, msg: '' });
            const [config, setConfig] = useState({ baseIn: "08:00", baseOut: "16:45" });
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                actualOut: '',
                note: ''
            });

            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.FB_SERVICES) {
                        clearInterval(checkFB);
                        initApp();
                    }
                }, 100);
            }, []);

            const initApp = () => {
                const { auth, db, appId, signInAnonymously, onAuthStateChanged, onSnapshot, doc, collection } = window.FB_SERVICES;
                
                signInAnonymously(auth).catch(console.error);
                
                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        
                        // Cargar Config
                        onSnapshot(doc(db, 'artifacts', appId, 'users', u.uid, 'settings', 'userConfig'), (snap) => {
                            if (snap.exists()) setConfig(snap.data());
                        });

                        // Cargar Entradas
                        onSnapshot(collection(db, 'artifacts', appId, 'users', u.uid, 'entries'), (snap) => {
                            const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            setEntries(data);
                            setLoading(false);
                        });
                    }
                });
            };

            const showToast = (msg) => {
                setToast({ show: true, msg });
                setTimeout(() => setToast({ show: false, msg: '' }), 3000);
            };

            const timeToMinutes = (t) => {
                const [h, m] = t.split(':').map(Number);
                return h * 60 + m;
            };

            const formatMinutes = (m) => {
                const mins = Math.abs(m);
                return `${Math.floor(mins / 60)}h ${mins % 60}m`;
            };

            const calculateExtra = (outTime) => {
                const actOutM = timeToMinutes(outTime);
                const baseOutM = timeToMinutes(config.baseOut);
                let extra = Math.max(0, actOutM - baseOutM);
                if (actOutM < timeToMinutes(config.baseIn)) extra = (actOutM + 1440) - baseOutM;
                return extra;
            };

            const saveEntry = async () => {
                if (!formData.date || !formData.actualOut) return showToast('‚ö†Ô∏è Datos incompletos');
                const { db, appId, collection, addDoc } = window.FB_SERVICES;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'entries'), {
                    ...formData, createdAt: new Date().toISOString()
                });
                setFormData({ ...formData, actualOut: '', note: '' });
                showToast('‚úÖ Guardado en la nube');
            };

            const deleteEntry = async (id) => {
                const { db, appId, doc, deleteDoc } = window.FB_SERVICES;
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'entries', id));
                showToast('üóëÔ∏è Eliminado');
            };

            const filtered = entries.filter(e => {
                const d = new Date(e.date + "T00:00:00");
                return d.getMonth() === viewingDate.getMonth() && d.getFullYear() === viewingDate.getFullYear();
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            const monthMins = filtered.reduce((acc, c) => acc + calculateExtra(c.actualOut), 0);

            if (loading) return (
                <div className="h-screen flex items-center justify-center">
                    <div className="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                </div>
            );

            return (
                <div className="max-w-2xl mx-auto p-4 md:p-6">
                    {/* Header */}
                    <div className="flex justify-between items-end mb-8">
                        <div>
                            <h1 className="text-2xl font-black text-slate-900 leading-tight">Overtime <span className="text-indigo-600">Cloud</span></h1>
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sincronizado</p>
                        </div>
                        <div className="text-right">
                            <span className="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-bold">LIVE</span>
                        </div>
                    </div>

                    {/* Selector */}
                    <div className="glass-card rounded-[2rem] p-2 flex items-center justify-between mb-6 shadow-sm">
                        <button onClick={() => setViewingDate(new Date(viewingDate.setMonth(viewingDate.getMonth() - 1)))} className="p-3 hover:bg-slate-50 rounded-2xl"><i data-lucide="chevron-left"></i></button>
                        <div className="text-center">
                            <h2 className="text-sm font-black capitalize text-slate-800">{viewingDate.toLocaleDateString('es', { month: 'long', year: 'numeric' })}</h2>
                        </div>
                        <button onClick={() => setViewingDate(new Date(viewingDate.setMonth(viewingDate.getMonth() + 1)))} className="p-3 hover:bg-slate-50 rounded-2xl"><i data-lucide="chevron-right"></i></button>
                    </div>

                    {/* Main Stat */}
                    <div className="bg-indigo-600 rounded-[2.5rem] p-8 text-white mb-8 shadow-xl shadow-indigo-100 relative overflow-hidden">
                        <div className="relative z-10">
                            <p className="text-[10px] font-bold uppercase tracking-wider opacity-70">Extra este mes</p>
                            <h3 className="text-5xl font-black mt-1">{formatMinutes(monthMins)}</h3>
                        </div>
                        <div className="absolute -right-4 -bottom-4 opacity-10 rotate-12"><i data-lucide="clock" size={120}></i></div>
                    </div>

                    {/* Formulario */}
                    <div className="glass-card rounded-[2.5rem] p-6 mb-8">
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase ml-2">Fecha</label>
                                    <input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full p-3 bg-slate-50 border-none rounded-2xl text-sm outline-none mt-1" />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase ml-2">Salida Real</label>
                                    <input type="time" value={formData.actualOut} onChange={e => setFormData({...formData, actualOut: e.target.value})} className="w-full p-3 bg-indigo-50 text-indigo-700 font-bold border-none rounded-2xl text-sm outline-none mt-1" />
                                </div>
                            </div>
                            <input type="text" placeholder="Nota r√°pida..." value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} className="w-full p-4 bg-slate-50 border-none rounded-2xl text-sm outline-none" />
                            <button onClick={saveEntry} className="w-full bg-slate-900 text-white font-bold py-4 rounded-3xl active:scale-95 transition-all shadow-lg">GUARDAR EN LA NUBE</button>
                        </div>
                    </div>

                    {/* Lista */}
                    <div className="space-y-3">
                        {filtered.length === 0 ? (
                            <div className="text-center py-10 text-slate-300 font-medium text-sm italic">No hay registros este mes</div>
                        ) : filtered.map(entry => (
                            <div key={entry.id} className="glass-card p-4 rounded-[2rem] flex justify-between items-center shadow-sm">
                                <div className="flex items-center gap-4">
                                    <div className="bg-slate-50 w-12 h-12 rounded-2xl flex flex-col items-center justify-center">
                                        <span className="text-[9px] font-bold text-slate-400 uppercase leading-none">{new Date(entry.date + "T00:00:00").toLocaleDateString('es', {month: 'short'})}</span>
                                        <span className="text-lg font-black text-slate-700 leading-none mt-1">{new Date(entry.date + "T00:00:00").getDate()}</span>
                                    </div>
                                    <div>
                                        <h4 className="text-sm font-bold text-slate-800 capitalize leading-none">{new Date(entry.date + "T00:00:00").toLocaleDateString('es', {weekday: 'long'})}</h4>
                                        <p className="text-[10px] text-slate-400 mt-1">Salida: {entry.actualOut} {entry.note && `‚Ä¢ ${entry.note}`}</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-lg font-black text-indigo-600">+{formatMinutes(calculateExtra(entry.actualOut))}</div>
                                    <button onClick={() => deleteEntry(entry.id)} className="text-[9px] font-bold text-red-300 uppercase hover:text-red-500 transition-colors">Eliminar</button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Toast */}
                    {toast.show && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-full shadow-2xl text-sm font-bold animate-bounce-slow z-50">
                            {toast.msg}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Initialize icons after React renders
        setTimeout(() => lucide.createIcons(), 500);
        document.addEventListener('click', () => setTimeout(() => lucide.createIcons(), 100));
    </script>
</body>
</html>
